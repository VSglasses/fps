<!doctype html>
<html oncontextmenu="return false;" style="touch-action:none;-webkit-user-select:none">
<canvas width=800 height=600>
<script>
'use strict'

const Canvas = document.currentScript.parentNode,
      [ CANVAS_W,CANVAS_H ] = [ 0 | Canvas.width,0 | Canvas.height ],
      OffCvs = document.createElement('canvas')

OffCvs.width  = CANVAS_W
OffCvs.height = CANVAS_H

const Ctx        = OffCvs.getContext('2d',{alpha:false,desynchronized:false}),
      CtxVisible = Canvas.getContext('2d',{alpha:false,desynchronized:true}),
      SAMPLING_FRAMES = 300,
      ONE_SEC = 1000, // milliseconds
      FONT_X = 10,
      FONT_H = 150

Canvas.onclick = Canvas.requestFullscreen

let [ px,py ] = [ 0,0 ]

document.onpointerdown =
document.onpointermove = e => {
    px = 0 | (e.pageX - Canvas.offsetLeft)
    py = 0 | (e.pageY - Canvas.offsetTop)
}

let frames = 0,
    ts0,
    fps0,fps1,fps2

Ctx.font = `${FONT_H}px serif`

const main = ts => {
    requestAnimationFrame(main)
    Ctx.fillStyle = 'black'
    Ctx.fillRect(0,0,CANVAS_W,CANVAS_H)

    const fps = ++frames / (ts - ts0) * ONE_SEC

    if (SAMPLING_FRAMES === frames) {
        fps2 = fps1
        fps1 = fps0
        fps0 = `${fps.toFixed(1)} FPS`
        frames = 0
        ts0 = ts
    }

    const PROGRESS = frames / SAMPLING_FRAMES

    let y = FONT_H * PROGRESS >> 0

    Ctx.fillStyle = 'red'
    Ctx.fillText((fps * PROGRESS).toFixed(1),FONT_X,y += FONT_H)

    Ctx.fillStyle = 'white'
    Ctx.fillText(fps0,FONT_X,y += FONT_H)
    Ctx.fillText(fps1,FONT_X,y += FONT_H)
    Ctx.fillText(fps2,FONT_X,y += FONT_H)

    Ctx.fillStyle = 'yellow'
    Ctx.fillRect(px-50,py-50,100,100)

    CtxVisible.drawImage(OffCvs,0,0)
}

requestAnimationFrame(ts => {
    ts0 = ts
    fps0 = fps1 = fps2 = ''
    requestAnimationFrame(main)
})

</script>
</canvas>
</html>
<!-- vim:set et ts=4 sw=0: -->
